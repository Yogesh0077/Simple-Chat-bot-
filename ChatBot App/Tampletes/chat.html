<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ChatBot Conversation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #10002b, #240046, #3c096c);
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
      }
      .chat-container {
        width: 420px;
        background: rgba(30, 30, 60, 0.95);
        border-radius: 20px;
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: fadeIn 0.8s ease;
      }
      .chat-header {
        padding: 15px 20px;
        font-size: 20px;
        font-weight: bold;
        background: linear-gradient(to right, #7209b7, #560bad);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      select {
        background-color: #320e57;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 5px;
        font-size: 14px;
      }
      .chat-box {
        height: 400px;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .message {
        display: flex;
        align-items: flex-end;
        gap: 10px;
      }
      .icon {
        width: 30px;
        height: 30px;
      }
      .bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 20px;
        font-size: 14px;
        line-height: 1.4;
        animation: popIn 0.3s ease;
      }
      .user {
        align-self: flex-end;
        flex-direction: row-reverse;
      }
      .user .bubble {
        background: linear-gradient(to right, #4cc9f0, #4361ee);
        border-bottom-right-radius: 0;
      }
      .bot .bubble {
        background: linear-gradient(to right, #b5179e, #7209b7);
        border-bottom-left-radius: 0;
      }
      .chat-input-area {
        display: flex;
        padding: 15px;
        background-color: #1e1e2e;
        align-items: center;
        gap: 10px;
      }
      .chat-input-area input[type="text"] {
        flex: 1;
        padding: 12px;
        border-radius: 30px;
        border: none;
        outline: none;
        font-size: 14px;
        background-color: #2a2a40;
        color: white;
      }
      .send-btn {
        padding: 12px;
        background: linear-gradient(to right, #f72585, #b5179e);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 18px;
        cursor: pointer;
      }
      .clear-btn {
        background: linear-gradient(to right, #ff6a00, #ee0979);
        color: white;
        border: none;
        padding: 12px;
        font-size: 16px;
        width: 100%;
        cursor: pointer;
        border-radius: 0 0 20px 20px;
      }
      .dot {
        font-size: 20px;
        animation: blink 1.4s infinite;
        display: inline-block;
        color: #fff;
      }
      .dot.two {
        animation-delay: 0.2s;
      }
      .dot.three {
        animation-delay: 0.4s;
      }
      @keyframes blink {
        0% {
          opacity: 0.2;
        }
        20% {
          opacity: 1;
        }
        100% {
          opacity: 0.2;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(40px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes popIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        ChatBot Conversation
        <select id="model-select">
          <option value="gemini" selected>Gemini Pro</option>
          <option value="dialogpt">DialoGPT</option>
        </select>
      </div>

      <div class="chat-box" id="chat-box">
        {% for chat in history %}
        <div class="message user">
          <img
            class="icon"
            src="https://img.icons8.com/ios-filled/50/user.png"
            alt="User icon"
          />
          <div class="bubble">{{ chat.user_input }}</div>
        </div>
        <div class="message bot">
          <img
            class="icon"
            src="https://img.icons8.com/ios-filled/50/robot.png"
            alt="Bot icon"
          />
          <div class="bubble">{{ chat.bot_response }}</div>
        </div>
        {% endfor %}
      </div>

      <form id="chat-form" class="chat-input-area" method="POST">
        {% csrf_token %}
        <input
          type="text"
          id="user_input"
          name="user_input"
          placeholder="Type a message..."
          required
          autocomplete="off"
        />
        <input type="hidden" id="model" name="model" value="gemini" />
        <button type="submit" class="send-btn" aria-label="Send message">
          &#10148;
        </button>
      </form>

      <form method="POST" action="{% url 'clear_chat' %}">
        {% csrf_token %}
        <button type="submit" class="clear-btn">Clear</button>
      </form>
    </div>

    <script>
      const form = document.getElementById("chat-form");
      const input = document.getElementById("user_input");
      const modelInput = document.getElementById("model");
      const modelSelect = document.getElementById("model-select");
      const chatBox = document.getElementById("chat-box");

      modelSelect.addEventListener("change", () => {
        modelInput.value = modelSelect.value;
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        const csrfToken = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        ).value;

        // Add user message to chat
        const userMsg = document.createElement("div");
        userMsg.className = "message user";
        userMsg.innerHTML = `
          <img class="icon" src="https://img.icons8.com/ios-filled/50/user.png" alt="User icon" />
          <div class="bubble">${text}</div>
        `;
        chatBox.appendChild(userMsg);
        gsap.from(userMsg, { duration: 0.3, y: 20, opacity: 0 });
        chatBox.scrollTop = chatBox.scrollHeight;
        input.value = "";

        // Add typing indicator
        const typingMsg = document.createElement("div");
        typingMsg.className = "message bot";
        typingMsg.id = "typing";
        typingMsg.innerHTML = `
          <img class="icon" src="https://img.icons8.com/ios-filled/50/robot.png" alt="Bot icon" />
          <div class="bubble">
            <span class="dot one">.</span>
            <span class="dot two">.</span>
            <span class="dot three">.</span>
          </div>
        `;
        chatBox.appendChild(typingMsg);
        chatBox.scrollTop = chatBox.scrollHeight;

        // Send POST request to server
        try {
          const response = await fetch("", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": csrfToken,
              "X-Requested-With": "XMLHttpRequest",
            },
            body: `user_input=${encodeURIComponent(text)}&model=${
              modelInput.value
            }`,
          });

          // Remove typing indicator
          typingMsg.remove();

          const data = await response.json();

          // Add bot response to chat
          const botMsg = document.createElement("div");
          botMsg.className = "message bot";
          botMsg.innerHTML = `
            <img class="icon" src="https://img.icons8.com/ios-filled/50/robot.png" alt="Bot icon" />
            <div class="bubble">${data.bot_response}</div>
          `;
          chatBox.appendChild(botMsg);
          gsap.from(botMsg, { duration: 0.3, y: 20, opacity: 0 });
          chatBox.scrollTop = chatBox.scrollHeight;
        } catch (error) {
          typingMsg.remove();
          alert("Error communicating with server. Please try again.");
        }
      });
    </script>
  </body>
</html>
